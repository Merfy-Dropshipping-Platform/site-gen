---
import BaseLayout from '../../layouts/BaseLayout.astro';
import data from '../../data/data.json';
import siteConfig from '../../data/site-config.json';
import products from '../../data/products.json';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

export function getStaticPaths() {
  const productList = products || [];
  return productList.map((product: any) => ({
    params: { id: product.slug ?? product.id },
    props: { product },
  }));
}

const { product } = Astro.props;
const meta = data?.meta ?? {};
const blocks = data?.content ?? [];
const headerBlock = blocks.find((b: any) => b.type === 'Header');
const footerBlock = blocks.find((b: any) => b.type === 'Footer');
const headerProps = headerBlock?.props ?? (siteConfig as any)?.header ?? {};
const footerProps = footerBlock?.props ?? (siteConfig as any)?.footer ?? {};

function formatPrice(price: string | number | null | undefined): string {
  if (price === null || price === undefined) return '0 ₽';
  if (typeof price === 'string') return price;
  return new Intl.NumberFormat('ru-RU', {
    style: 'currency',
    currency: 'RUB',
    minimumFractionDigits: 0,
  }).format(price);
}

// Handle both astro format (image: string) and raw format (images: string[])
const productImages: string[] = Array.isArray(product?.images)
  ? product.images
  : product?.image
    ? [product.image]
    : [];
const mainImage = productImages[0] || null;
const hasMultipleImages = productImages.length > 1;
---
<BaseLayout title={`${product?.name ?? 'Товар'} — ${meta?.title ?? 'Мой магазин'}`} description={product?.description}>
  <Header {...headerProps} />

  <main class="flex-1 w-full max-w-[1200px] mx-auto px-5 py-10 font-manrope">
    <p class="mb-8 text-sm text-gray-500">
      <a href="/" class="text-gray-500 hover:text-black">Главная</a>
      <span class="mx-1">/</span>
      <a href="/catalog" class="text-gray-500 hover:text-black">Каталог</a>
      <span class="mx-1">/</span>
      <span class="text-black">{product?.name}</span>
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-[60px]">
      <!-- Gallery -->
      <div class="flex flex-col gap-4">
        <div class="aspect-[3/4] bg-gray-100 rounded-2xl overflow-hidden" id="main-image-container">
          {mainImage ? (
            <img id="main-product-image" src={mainImage} alt={product.name} class="w-full h-full object-cover" />
          ) : (
            <div class="w-full h-full flex items-center justify-center text-gray-300">
              <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21,15 16,10 5,21"/>
              </svg>
            </div>
          )}
        </div>
        {hasMultipleImages && (
          <div class="flex gap-2 overflow-x-auto pb-1" id="thumbnail-strip">
            {productImages.map((img: string, i: number) => (
              <button
                type="button"
                class:list={[
                  'thumb-btn w-20 h-20 flex-shrink-0 rounded-lg overflow-hidden border-2 transition-colors cursor-pointer',
                  i === 0 ? 'border-[#e11d48]' : 'border-transparent hover:border-gray-300',
                ]}
                data-index={i}
                data-src={img}
              >
                <img src={img} alt={`${product.name} — фото ${i + 1}`} class="w-full h-full object-cover" />
              </button>
            ))}
          </div>
        )}
      </div>

      <!-- Details -->
      <div class="pt-0 md:pt-5 flex flex-col">
        <h1 class="text-3xl md:text-4xl font-comfortaa mb-4 leading-tight">{product?.name}</h1>

        <div class="flex items-center gap-3 mb-6">
          <span class="text-2xl font-semibold text-[#e11d48]">{formatPrice(product?.price ?? 0)}</span>
          {(product?.compareAtPrice ?? product?.oldPrice) && (
            <span class="text-lg text-gray-400 line-through">{formatPrice(product.compareAtPrice ?? product.oldPrice)}</span>
          )}
        </div>

        {product?.description && (
          <p class="text-base text-gray-600 leading-relaxed mb-8">{product.description}</p>
        )}

        <a
          href={`/checkout?productId=${product.slug ?? product.id}`}
          class="inline-flex items-center justify-center py-4 px-12 bg-[#e11d48] text-white rounded-xl font-medium hover:bg-[#be123c] transition-colors no-underline mt-auto"
        >
          Купить сейчас
        </a>
      </div>
    </div>
  </main>

  <Footer {...footerProps} />
</BaseLayout>

{hasMultipleImages && (
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      var strip = document.getElementById('thumbnail-strip');
      var mainImg = document.getElementById('main-product-image');
      if (!strip || !mainImg) return;

      strip.addEventListener('click', function(e) {
        var btn = e.target.closest('.thumb-btn');
        if (!btn) return;
        var src = btn.getAttribute('data-src');
        if (!src) return;

        mainImg.setAttribute('src', src);

        strip.querySelectorAll('.thumb-btn').forEach(function(b) {
          b.classList.remove('border-[#e11d48]');
          b.classList.add('border-transparent');
        });
        btn.classList.remove('border-transparent');
        btn.classList.add('border-[#e11d48]');
      });
    });
  </script>
)}
