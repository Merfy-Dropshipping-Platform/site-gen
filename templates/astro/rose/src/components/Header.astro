---
import NavLink from './header/NavLink.astro';
import IconButton from './header/IconButton.astro';

interface Props {
  siteTitle?: string;
  logo?: string;
  navigationLinks?: Array<{ label: string; href: string; submenu?: Array<{ label: string; href: string }> }>;
  actionButtons?: { showSearch?: string; showCart?: string; showProfile?: string };
}

const {
  siteTitle = 'Rose Theme',
  logo = '/logo.svg',
  navigationLinks = [
    { label: 'Главная', href: '/' },
    { label: 'Каталог', href: '/catalog' },
    { label: 'О нас', href: '/about' },
    { label: 'Контакты', href: '/contacts' },
  ],
  actionButtons = { showSearch: 'true', showCart: 'true', showProfile: 'true' },
} = Astro.props;

const showSearch = actionButtons?.showSearch === 'true';
const showCart = actionButtons?.showCart === 'true';
const showProfile = actionButtons?.showProfile === 'true';
---

<div class="w-full sticky top-0 z-50 bg-white shadow-sm">
  <header class="bg-white w-full h-16 sm:h-20 md:h-24 lg:h-28 xl:h-[120px] flex items-center border-b border-gray-100">
    <nav class="w-full max-w-[1920px] mx-auto px-4 sm:px-6 md:px-8 lg:px-16 xl:px-24 2xl:px-[300px] flex items-center justify-between">
      <!-- Mobile: Hamburger Menu -->
      <button
        id="mobile-menu-button"
        aria-label="Меню"
        aria-expanded="false"
        class="md:hidden w-10 h-10 flex items-center justify-center hover:opacity-70 transition-opacity"
      >
        <svg id="menu-icon" width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path id="menu-line-1" d="M11 17H29" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
          <path id="menu-line-2" d="M11 23H29" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <!-- Logo -->
      <div class="absolute left-1/2 -translate-x-1/2 md:relative md:left-auto md:transform-none">
        <a href="/" class="flex items-center hover:opacity-80 transition-opacity">
          {logo ? (
            <img src={logo} alt={siteTitle} class="h-5 sm:h-6 md:h-[26px] w-auto" />
          ) : (
            <span class="text-lg sm:text-xl md:text-2xl font-comfortaa font-normal">{siteTitle}</span>
          )}
        </a>
      </div>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-4 lg:gap-8 xl:gap-12 2xl:gap-[80px]">
        {navigationLinks?.map((link, i) => (
          <NavLink href={link.href} active={i === 0}>{link.label}</NavLink>
        ))}
      </div>

      <!-- Mobile Navigation Menu -->
      <div
        id="mobile-menu"
        class="hidden md:hidden absolute top-full left-0 right-0 bg-white border-b border-gray-200 z-50"
      >
        <nav class="flex flex-col" aria-label="Мобильная навигация">
          {showSearch && (
            <div class="px-4 pt-6 pb-4">
              <div class="relative">
                <input
                  type="search"
                  placeholder="Поиск..."
                  class="block w-full h-12 pl-5 pr-12 bg-white border border-gray-300 rounded-lg text-sm font-normal text-black placeholder:text-gray-400 outline-none focus:border-gray-400 font-manrope"
                />
                <button class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5">
                  <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </button>
              </div>
            </div>
          )}
          <div class="flex flex-col">
            {navigationLinks?.map((link) => {
              const hasSubmenu = link.submenu && link.submenu.length > 0;
              return hasSubmenu ? (
                <div class="border-t border-gray-200">
                  <button
                    class="mobile-submenu-toggle w-full px-4 py-4 text-base font-normal text-black hover:bg-gray-50 transition-colors flex items-center justify-between font-manrope"
                    data-target={`submenu-${link.label}`}
                  >
                    <span>{link.label}</span>
                    <svg class="w-4 h-4 transition-transform submenu-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>
                  <div class="hidden bg-gray-50 mobile-submenu" data-id={`submenu-${link.label}`}>
                    {link.submenu?.map((sub) => (
                      <a href={sub.href} class="block px-8 py-3 text-sm font-normal text-gray-600 hover:text-black transition-colors font-manrope border-t border-gray-200">
                        {sub.label}
                      </a>
                    ))}
                  </div>
                </div>
              ) : (
                <a href={link.href} class="px-4 py-4 text-base font-normal text-black hover:bg-gray-50 transition-colors border-t border-gray-200 font-manrope">
                  {link.label}
                </a>
              );
            })}
          </div>
        </nav>
      </div>

      <!-- Action Buttons -->
      <div class="flex items-center gap-3 sm:gap-3 md:gap-4 lg:gap-5 xl:gap-[25px]">
        {showSearch && (
          <div class="hidden md:block">
            <IconButton icon="/search.svg" label="Поиск" />
          </div>
        )}
        {showCart && (
          <a href="/cart" id="header-cart-link" class="relative w-8 h-8 sm:w-9 sm:h-9 md:w-10 md:h-10 flex items-center justify-center hover:opacity-70 transition-opacity" aria-label="Корзина">
            <img src="/cart.svg" alt="Корзина" class="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 lg:w-10 lg:h-10" />
            <span id="cart-badge" class="hidden absolute -top-1 -right-1 bg-[#e11d48] text-white text-[10px] font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center leading-none px-1">0</span>
          </a>
        )}
        {showProfile && <IconButton icon="/profile.svg" label="Аккаунт" />}
      </div>
    </nav>
  </header>
</div>

<script>
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');

  if (mobileMenuButton && mobileMenu) {
    const menuIcon = document.getElementById('menu-icon');
    mobileMenuButton.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
      const isOpen = !mobileMenu.classList.contains('hidden');
      mobileMenuButton.setAttribute('aria-expanded', String(isOpen));
      if (menuIcon) {
        menuIcon.classList.toggle('menu-open', isOpen);
      }
    });
  }

  document.querySelectorAll('.mobile-submenu-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.getAttribute('data-target');
      const submenu = document.querySelector(`.mobile-submenu[data-id="${targetId}"]`);
      const arrow = btn.querySelector('.submenu-arrow');
      if (submenu) submenu.classList.toggle('hidden');
      if (arrow) arrow.classList.toggle('rotate-180');
    });
  });

  const menuLinks = mobileMenu?.querySelectorAll('a');
  menuLinks?.forEach(link => {
    link.addEventListener('click', () => {
      mobileMenu?.classList.add('hidden');
      mobileMenuButton?.setAttribute('aria-expanded', 'false');
      document.getElementById('menu-icon')?.classList.remove('menu-open');
    });
  });

  // Cart badge update
  function updateCartBadge() {
    const badge = document.getElementById('cart-badge');
    if (!badge) return;
    const count = window.cartStore ? window.cartStore.getCount() : 0;
    if (count > 0) {
      badge.textContent = String(count > 99 ? '99+' : count);
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  }

  document.addEventListener('cart:updated', updateCartBadge);
  // Initial badge state after cart init
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(updateCartBadge, 100);
  });

  // Mark buttons for products already in cart
  function syncCartButtons() {
    if (!window.cartStore) return;
    const items = window.cartStore.getItems();
    const inCartIds = new Set(items.map((i: any) => i.productId));
    document.querySelectorAll('.add-to-cart-btn').forEach((btn) => {
      if (!(btn instanceof HTMLButtonElement)) return;
      const pid = btn.dataset.productId;
      if (pid && inCartIds.has(pid)) {
        btn.textContent = 'В корзине ✓';
        btn.classList.remove('bg-[#e11d48]', 'hover:bg-[#be123c]');
        btn.classList.add('bg-gray-500');
        btn.disabled = false;
      } else if (pid) {
        btn.textContent = 'В корзину';
        btn.classList.remove('bg-gray-500');
        btn.classList.add('bg-[#e11d48]', 'hover:bg-[#be123c]');
        btn.disabled = false;
      }
    });
  }

  // Sync on cart updates and page load
  document.addEventListener('cart:updated', syncCartButtons);
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(syncCartButtons, 200);
  });

  // Add-to-cart button handler (delegated)
  document.addEventListener('click', async (e) => {
    const btn = (e.target as Element).closest('.add-to-cart-btn');
    if (!btn || !(btn instanceof HTMLButtonElement)) return;

    const productId = btn.dataset.productId;
    if (!productId || !window.cartStore) return;

    // If already in cart, open drawer instead
    const items = window.cartStore.getItems();
    if (items.some((i: any) => i.productId === productId)) {
      if (window.cartDrawer) window.cartDrawer.open();
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Добавляем...';

    const ok = await window.cartStore.addItem(productId, null, 1);

    if (ok) {
      btn.textContent = 'В корзине ✓';
      btn.classList.remove('bg-[#e11d48]', 'hover:bg-[#be123c]');
      btn.classList.add('bg-gray-500');
      btn.disabled = false;
    } else {
      btn.textContent = 'Ошибка';
      setTimeout(() => {
        btn.textContent = 'В корзину';
        btn.disabled = false;
      }, 1500);
    }
  });
</script>
