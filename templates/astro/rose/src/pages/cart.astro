---
import BaseLayout from '../layouts/BaseLayout.astro';
import data from '../data/data.json';
import siteConfig from '../data/site-config.json';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

const meta = data?.meta ?? {};
const blocks = data?.content ?? [];
const headerBlock = blocks.find((b: any) => b.type === 'Header');
const footerBlock = blocks.find((b: any) => b.type === 'Footer');
const headerProps = headerBlock?.props ?? (siteConfig as any)?.header ?? {};
const footerProps = footerBlock?.props ?? (siteConfig as any)?.footer ?? {};
---
<BaseLayout title={`Корзина — ${meta?.title ?? 'Мой магазин'}`}>
  <Header {...headerProps} />

  <main class="flex-1 w-full max-w-[1200px] mx-auto px-5 py-10 font-manrope">
    <p class="mb-8 text-sm text-gray-500">
      <a href="/" class="text-gray-500 hover:text-black">Главная</a>
      <span class="mx-1">/</span>
      <span class="text-black">Корзина</span>
    </p>

    <h1 class="text-3xl md:text-4xl font-comfortaa mb-8">Корзина</h1>

    <!-- Empty state (shown by default, hidden via JS when items exist) -->
    <div id="cart-page-empty" class="text-center py-16">
      <div class="mb-4">
        <svg class="mx-auto text-gray-300" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
      </div>
      <p class="text-lg text-gray-500 mb-6">Корзина пуста</p>
      <a href="/catalog" class="inline-flex items-center justify-center py-3 px-8 bg-[#e11d48] text-white rounded-xl font-medium hover:bg-[#be123c] transition-colors no-underline">
        Перейти в каталог
      </a>
    </div>

    <!-- Cart items (hidden by default, shown via JS) -->
    <div id="cart-page-content" class="hidden">
      <!-- Desktop table view -->
      <div class="hidden md:block">
        <div class="grid grid-cols-[1fr_auto_auto_auto] gap-4 pb-3 border-b border-gray-200 text-sm text-gray-500 font-medium">
          <span>Товар</span>
          <span class="text-center w-[140px]">Количество</span>
          <span class="text-right w-[100px]">Сумма</span>
          <span class="w-[40px]"></span>
        </div>
        <div id="cart-page-items-desktop"></div>
      </div>

      <!-- Mobile list view -->
      <div class="md:hidden">
        <div id="cart-page-items-mobile"></div>
      </div>

      <!-- Bottom section -->
      <div class="mt-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <a href="/catalog" class="text-gray-500 hover:text-[#e11d48] transition-colors text-sm no-underline">
          ← Продолжить покупки
        </a>
        <div class="flex flex-col items-end gap-4">
          <div class="text-right">
            <span class="text-gray-500 text-sm">Итого: </span>
            <span id="cart-page-total" class="text-2xl font-bold text-black">0 ₽</span>
          </div>
          <a href="/checkout" class="inline-flex items-center justify-center py-4 px-12 bg-[#e11d48] text-white rounded-xl font-medium hover:bg-[#be123c] transition-colors no-underline">
            Оформить заказ
          </a>
        </div>
      </div>
    </div>
  </main>

  <Footer {...footerProps} />
</BaseLayout>

<script is:inline>
  function formatCartPrice(cents) {
    if (!cents && cents !== 0) return '0 ₽';
    var rub = cents / 100;
    return new Intl.NumberFormat('ru-RU', {
      style: 'currency',
      currency: 'RUB',
      minimumFractionDigits: 0,
    }).format(rub);
  }

  function renderCartPage() {
    var emptyEl = document.getElementById('cart-page-empty');
    var contentEl = document.getElementById('cart-page-content');
    var desktopContainer = document.getElementById('cart-page-items-desktop');
    var mobileContainer = document.getElementById('cart-page-items-mobile');
    var totalEl = document.getElementById('cart-page-total');
    if (!emptyEl || !contentEl) return;

    var items = window.cartStore ? window.cartStore.getItems() : [];

    if (items.length === 0) {
      emptyEl.classList.remove('hidden');
      contentEl.classList.add('hidden');
      return;
    }

    emptyEl.classList.add('hidden');
    contentEl.classList.remove('hidden');

    // Desktop rows
    if (desktopContainer) {
      desktopContainer.innerHTML = items.map(function(item) {
        var img = item.imageUrl || (item.images && item.images[0]) || item.image || '';
        var name = item.name || item.productName || 'Товар';
        var price = item.unitPriceCents || item.priceCents || item.price || 0;
        var qty = item.quantity || 1;
        var lineTotal = price * qty;
        var imgHtml = img
          ? '<img src="' + img + '" alt="' + name + '" class="w-16 h-16 rounded-lg object-cover bg-gray-100 flex-shrink-0" />'
          : '<div class="w-16 h-16 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0 text-gray-300"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></div>';

        return '<div class="grid grid-cols-[1fr_auto_auto_auto] gap-4 py-4 border-b border-gray-100 items-center">' +
          '<div class="flex items-center gap-4 min-w-0">' +
            imgHtml +
            '<div class="min-w-0">' +
              '<div class="font-medium text-sm text-gray-900 truncate">' + name + '</div>' +
              '<div class="text-sm text-[#e11d48] font-semibold mt-0.5">' + formatCartPrice(price) + '</div>' +
            '</div>' +
          '</div>' +
          '<div class="flex items-center gap-2 w-[140px] justify-center">' +
            '<button class="cart-page-qty-btn w-8 h-8 border border-gray-200 rounded-lg flex items-center justify-center text-gray-600 hover:bg-gray-50" data-action="decrease" data-item-id="' + item.id + '"' + (qty <= 1 ? ' disabled' : '') + '>−</button>' +
            '<span class="w-8 text-center text-sm font-medium">' + qty + '</span>' +
            '<button class="cart-page-qty-btn w-8 h-8 border border-gray-200 rounded-lg flex items-center justify-center text-gray-600 hover:bg-gray-50" data-action="increase" data-item-id="' + item.id + '">+</button>' +
          '</div>' +
          '<div class="text-right w-[100px] font-semibold text-sm">' + formatCartPrice(lineTotal) + '</div>' +
          '<div class="w-[40px] text-center">' +
            '<button class="text-gray-400 hover:text-red-500 transition-colors" data-action="remove" data-item-id="' + item.id + '" aria-label="Удалить">' +
              '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>' +
            '</button>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    // Mobile rows
    if (mobileContainer) {
      mobileContainer.innerHTML = items.map(function(item) {
        var img = item.imageUrl || (item.images && item.images[0]) || item.image || '';
        var name = item.name || item.productName || 'Товар';
        var price = item.unitPriceCents || item.priceCents || item.price || 0;
        var qty = item.quantity || 1;
        var lineTotal = price * qty;
        var imgHtml = img
          ? '<img src="' + img + '" alt="' + name + '" class="w-20 h-20 rounded-lg object-cover bg-gray-100 flex-shrink-0" />'
          : '<div class="w-20 h-20 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0 text-gray-300"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></div>';

        return '<div class="flex gap-3 py-4 border-b border-gray-100">' +
          imgHtml +
          '<div class="flex-1 min-w-0">' +
            '<div class="flex justify-between items-start">' +
              '<div class="font-medium text-sm text-gray-900 truncate pr-2">' + name + '</div>' +
              '<button class="text-gray-400 hover:text-red-500 flex-shrink-0" data-action="remove" data-item-id="' + item.id + '" aria-label="Удалить">' +
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>' +
              '</button>' +
            '</div>' +
            '<div class="text-sm text-[#e11d48] font-semibold mt-1">' + formatCartPrice(price) + '</div>' +
            '<div class="flex items-center justify-between mt-2">' +
              '<div class="flex items-center gap-2">' +
                '<button class="cart-page-qty-btn w-7 h-7 border border-gray-200 rounded-md flex items-center justify-center text-gray-600" data-action="decrease" data-item-id="' + item.id + '"' + (qty <= 1 ? ' disabled' : '') + '>−</button>' +
                '<span class="w-6 text-center text-sm font-medium">' + qty + '</span>' +
                '<button class="cart-page-qty-btn w-7 h-7 border border-gray-200 rounded-md flex items-center justify-center text-gray-600" data-action="increase" data-item-id="' + item.id + '">+</button>' +
              '</div>' +
              '<div class="font-semibold text-sm">' + formatCartPrice(lineTotal) + '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    // Total
    if (totalEl) {
      var total = window.cartStore ? window.cartStore.getTotal() : 0;
      totalEl.textContent = formatCartPrice(total);
    }
  }

  // Handle quantity/remove clicks
  document.addEventListener('click', async function(e) {
    var btn = e.target.closest('[data-action]');
    if (!btn || !window.cartStore) return;
    // Only handle clicks within cart page
    var inCartPage = btn.closest('#cart-page-content');
    if (!inCartPage) return;

    var action = btn.getAttribute('data-action');
    var itemId = btn.getAttribute('data-item-id');
    if (!itemId) return;

    btn.disabled = true;

    if (action === 'remove') {
      await window.cartStore.removeItem(itemId);
    } else if (action === 'decrease') {
      var items = window.cartStore.getItems();
      var item = items.find(function(i) { return i.id === itemId; });
      if (item && item.quantity > 1) {
        await window.cartStore.updateQuantity(itemId, item.quantity - 1);
      }
    } else if (action === 'increase') {
      var items = window.cartStore.getItems();
      var item = items.find(function(i) { return i.id === itemId; });
      if (item) {
        await window.cartStore.updateQuantity(itemId, item.quantity + 1);
      }
    }

    btn.disabled = false;
  });

  // Re-render on cart updates
  document.addEventListener('cart:updated', renderCartPage);

  // Initial render
  document.addEventListener('DOMContentLoaded', function() {
    // Wait for cart init
    setTimeout(renderCartPage, 150);
  });
</script>
