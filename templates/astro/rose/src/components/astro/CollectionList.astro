---
/**
 * CollectionList.astro -- Static SSG version.
 *
 * Renders a grid of collection cards with images.
 * Matches the visual design of react/CollectionList.tsx.
 * Falls back to data from collections.json or provided props.
 */
import SectionHeader from '../shared/SectionHeader.astro';

interface CollectionData {
  id?: string;
  handle?: string;
  title?: string;
  name?: string;
  image?: string | { url: string; alt?: string };
  description?: string;
}

interface Props {
  title?: string;
  subtitle?: string;
  collections?: CollectionData[];
  columns?: number;
  dataSource?: string;
  padding?: { top?: number; bottom?: number };
}

const {
  title = 'Коллекции',
  subtitle,
  collections: propCollections = [],
  columns = 3,
  dataSource = 'auto',
  padding = { top: 80, bottom: 80 },
} = Astro.props;

let collections = propCollections;

// Load from data file if auto or no collections provided
if (dataSource === 'auto' || collections.length === 0) {
  try {
    const imported = await import('../../data/collections.json');
    collections = imported.default || [];
  } catch {
    collections = [];
  }
}

// Normalize image format
function getImageUrl(image: string | { url: string; alt?: string } | undefined): string {
  if (!image) return '';
  if (typeof image === 'string') return image;
  return image.url ?? '';
}

function getImageAlt(image: string | { url: string; alt?: string } | undefined, fallback: string): string {
  if (!image) return fallback;
  if (typeof image === 'string') return fallback;
  return image.alt ?? fallback;
}
---

<section
  class="w-full"
  style={`padding: ${padding?.top ?? 80}px 0 ${padding?.bottom ?? 80}px;`}
>
  <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 md:px-8 lg:px-10 xl:px-12">
    <SectionHeader title={title} subtitle={subtitle} />

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 sm:gap-8 md:gap-10 collection-list-grid" role="list">
      {collections.map((collection, index) => {
        const collectionTitle = collection.title ?? collection.name ?? 'Коллекция';
        const imageUrl = getImageUrl(collection.image);
        const imageAlt = getImageAlt(collection.image, `Коллекция ${collectionTitle}`);
        const href = collection.handle ? `/collections/${collection.handle}` : '#';

        return (
          <a
            href={href}
            class="group cursor-pointer no-underline text-inherit"
            role="listitem"
            aria-label={`Коллекция ${collectionTitle}`}
          >
            <div class="relative w-full aspect-[430/500] bg-gray-100 rounded-xl sm:rounded-2xl overflow-hidden mb-4 sm:mb-5 md:mb-6 shadow-sm hover:shadow-lg transition-shadow duration-300">
              {imageUrl ? (
                <img
                  src={imageUrl}
                  alt={imageAlt}
                  class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500 ease-out"
                  loading={index < 2 ? 'eager' : 'lazy'}
                  width="430"
                  height="500"
                />
              ) : (
                <div class="w-full h-full flex items-center justify-center text-gray-300">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                    <circle cx="8.5" cy="8.5" r="1.5" />
                    <polyline points="21,15 16,10 5,21" />
                  </svg>
                </div>
              )}
              <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors duration-300"></div>
            </div>
            <div class="px-1 sm:px-2">
              <h3 class="text-lg sm:text-xl md:text-2xl font-normal text-black group-hover:text-gray-700 transition-colors duration-200 font-[family-name:var(--font-body)]">
                {collectionTitle}
              </h3>
            </div>
          </a>
        );
      })}
    </div>
  </div>
</section>

<style define:vars={{ cols: columns }}>
  @media (min-width: 1024px) {
    .collection-list-grid {
      grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
    }
  }
</style>
